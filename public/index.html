
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kjøleskaps-kokken</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            width: 56px; height: 56px;
            border-radius: 50%;
            border: 8px solid #e5e7eb;
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .bg-image {
            background-image: url('https://images.unsplash.com/photo-1588113824128-1b45249a5b33?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .modal-bg { backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-100 bg-image">
    <div id="app-container" class="min-h-screen p-4 flex items-center justify-center bg-black bg-opacity-20">
        
        <!-- ===== 1. HJEMSIDE: Legg til ingredienser ===== -->
        <div id="home-view" class="w-full max-w-2xl mx-auto">
            <header class="text-center mb-10">
                <i class="ph ph-chef-hat text-7xl text-white"></i>
                <h1 class="text-6xl font-black mt-2 text-white">Kjøleskaps-kokken</h1>
                <p class="text-slate-200 mt-4 text-xl">Åpne kjøleskapet, finn frem det du har, og la oss trylle frem ditt neste favorittmåltid sammen!</p>
            </header>

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="mb-4">
                    <div id="ingredient-req-message" class="p-3 rounded-lg text-center font-semibold mb-4 transition-colors duration-300">
                        <i class="ph ph-info"></i> Legg til minst 3 ingredienser for å få best resultat.
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="ingredient-input" placeholder="F.eks. kylling, tomat, fløte..." class="flex-grow w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <button id="add-ingredient-btn" class="bg-indigo-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">Legg til</button>
                    </div>
                </div>

                <div id="ingredients-list" class="flex flex-wrap gap-2 mb-6 min-h-[40px]"></div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Velg type måltid:</label>
                    <div id="meal-type-selector" class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                         <button data-meal="Frokost" class="meal-btn w-full px-4 py-2 border rounded-lg transition">Frokost</button>
                         <button data-meal="Lunsj" class="meal-btn w-full px-4 py-2 border rounded-lg transition">Lunsj</button>
                         <button data-meal="Middag" class="meal-btn w-full px-4 py-2 border rounded-lg transition">Middag</button>
                         <button data-meal="Kveldsmat" class="meal-btn w-full px-4 py-2 border rounded-lg transition">Kveldsmat</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="num-people" class="block text-sm font-medium text-slate-700 mb-1">Antall personer:</label>
                        <input type="number" id="num-people" value="2" min="1" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                     <div>
                        <label for="num-recipes" class="block text-sm font-medium text-slate-700 mb-1">Antall oppskriftsforslag: <span class="font-normal text-slate-500">(maks 3)</span></label>
                        <input type="number" id="num-recipes" value="3" min="1" max="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    <div>
                        <label for="calories" class="block text-sm font-medium text-slate-700 mb-1">Ca. kalorier (valgfritt):</label>
                        <input type="number" id="calories" placeholder="F.eks. 600" min="0" step="50" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                     <div>
                        <label for="protein" class="block text-sm font-medium text-slate-700 mb-1">Ca. protein (g) (valgfritt):</label>
                        <input type="number" id="protein" placeholder="F.eks. 30" min="0" step="5" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                </div>

                <button id="find-recipes-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition flex items-center justify-center gap-2 text-lg shadow-lg disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                    <i class="ph ph-magic-wand"></i> Finn Oppskrifter!
                </button>
            </div>
            <div id="saved-recipes-link-container" class="text-center mt-8 hidden">
                <button onclick="showView('saved-view')" class="bg-red-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition shadow-lg flex items-center justify-center gap-2 mx-auto transform hover:scale-105">
                    <i class="ph-fill ph-heart"></i> Mine Lagrede Oppskrifter
                </button>
            </div>
        </div>

        <!-- ===== 2. RESULTATSIDE: Velg en oppskrift ===== -->
        <div id="results-view" class="w-full max-w-4xl mx-auto hidden">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showView('home-view')" class="flex items-center gap-2 text-slate-600 hover:text-indigo-600 font-semibold">
                    <i class="ph ph-arrow-left"></i> Tilbake til ingredienser
                </button>
                <div id="results-saved-recipes-link-container" class="hidden">
                    <button onclick="showView('saved-view')" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition shadow-md flex items-center justify-center gap-2 transform hover:scale-105 text-sm">
                        <i class="ph-fill ph-heart"></i> Mine Favoritter
                    </button>
                </div>
            </div>
            <h2 class="text-3xl font-bold text-center mb-6">Her er noen forslag...</h2>
            <div id="results-loader" class="text-center py-10 hidden">
                <div class="spinner mx-auto"></div>
                <p class="mt-4 text-slate-600 font-semibold">Kjøleskaps-kokken tenker...</p>
            </div>
            <div id="results-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative hidden" role="alert"></div>
            <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- ===== 3. DETALJSIDE: Se oppskrift ===== -->
        <div id="details-view" class="w-full max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg hidden"></div>

        <!-- ===== 4. LAGREDE OPPSKRIFTER ===== -->
        <div id="saved-view" class="w-full max-w-4xl mx-auto hidden">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showView('home-view')" class="flex items-center gap-2 text-slate-600 hover:text-indigo-600 font-semibold">
                    <i class="ph ph-arrow-left"></i> Tilbake til startsiden
                </button>
            </div>
            <h2 class="text-3xl font-bold text-center mb-6">Mine Lagrede Oppskrifter</h2>
            <div id="no-saved-recipes" class="text-center text-slate-500 py-10 hidden">
                <i class="ph ph-heart-break text-5xl"></i>
                <p class="mt-4">Du har ingen lagrede oppskrifter ennå.</p>
            </div>
            <div id="saved-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>
    
    <!-- Flytende AI-hjelp knapp -->
    <button id="ai-help-fab" class="fixed bottom-6 right-6 bg-indigo-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 transition transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <i class="ph ph-chats-circle text-3xl"></i>
    </button>

    <!-- AI Hjelp Modal -->
    <div id="ai-help-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50 modal-bg" onclick="toggleModal('ai-help-modal', false)"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg m-4 max-h-[80vh] flex flex-col relative z-10">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="ai-modal-title" class="text-lg font-bold">Spør Kjøleskaps-kokken</h3>
                <button onclick="toggleModal('ai-help-modal', false)" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div id="ai-chat-box" class="p-4 flex-grow overflow-y-auto space-y-4">
                <!-- Chat-meldinger havner her -->
            </div>
            <div class="p-4 border-t">
                <div id="ai-chat-error" class="text-red-600 text-sm mb-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="ai-question-input" placeholder="Spør om hva som helst..." class="flex-grow w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="ai-send-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center">
                        <span id="ai-send-text">Send</span>
                        <div id="ai-send-spinner" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ---------- STATE ----------
        let ingredients = [];
        let generatedRecipes = [];
        let selectedRecipe = null;
        let savedRecipes = [];
        let aiConversation = [];
        
        const API_BASE_URL = 'https://kjoleskapskokken.onrender.com';

        // ---------- DOM ELEMENTS ----------
        const views = {
            'home-view': document.getElementById('home-view'),
            'results-view': document.getElementById('results-view'),
            'details-view': document.getElementById('details-view'),
            'saved-view': document.getElementById('saved-view')
        };
        const ingredientInput = document.getElementById('ingredient-input');
        const addIngredientBtn = document.getElementById('add-ingredient-btn');
        const ingredientsList = document.getElementById('ingredients-list');
        const findRecipesBtn = document.getElementById('find-recipes-btn');
        const ingredientReqMessage = document.getElementById('ingredient-req-message');
        const resultsGrid = document.getElementById('results-grid');
        const resultsLoader = document.getElementById('results-loader');
        const resultsError = document.getElementById('results-error');
        const detailsView = document.getElementById('details-view');
        const mealTypeSelector = document.getElementById('meal-type-selector');

        const savedGrid = document.getElementById('saved-grid');
        const noSavedRecipes = document.getElementById('no-saved-recipes');
        const savedRecipesLinkContainer = document.getElementById('saved-recipes-link-container');
        const resultsSavedRecipesLinkContainer = document.getElementById('results-saved-recipes-link-container');
        
        const aiHelpFab = document.getElementById('ai-help-fab');
        const aiHelpModal = document.getElementById('ai-help-modal');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiChatBox = document.getElementById('ai-chat-box');
        const aiQuestionInput = document.getElementById('ai-question-input');
        const aiSendBtn = document.getElementById('ai-send-btn');
        const aiChatError = document.getElementById('ai-chat-error');

        // ---------- FUNKSJONER ----------
        
        function showView(viewId) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if(views[viewId]) {
                views[viewId].classList.remove('hidden');
            } else {
                console.error(`View med id '${viewId}' ble ikke funnet.`);
            }
        }
        
        function updateIngredientButton() {
            const remaining = 3 - ingredients.length;
            if (remaining <= 0) {
                ingredientReqMessage.innerHTML = `<i class="ph-fill ph-check-circle"></i> Du er klar! Trykk på knappen nedenfor.`;
                ingredientReqMessage.className = 'p-3 rounded-lg text-center font-semibold mb-4 transition-colors duration-300 bg-green-100 text-green-700';
                findRecipesBtn.disabled = false;
            } else {
                ingredientReqMessage.innerHTML = `<i class="ph ph-info"></i> Legg til minst <strong>${remaining}</strong> ingrediens(er) til for å få best resultat.`;
                ingredientReqMessage.className = 'p-3 rounded-lg text-center font-semibold mb-4 transition-colors duration-300 bg-indigo-100 text-indigo-700';
                findRecipesBtn.disabled = true;
            }
        }

        function renderIngredients() {
            ingredientsList.innerHTML = ingredients.map((ing, index) => `
                <div class="bg-indigo-100 text-indigo-800 text-sm font-semibold px-3 py-1.5 rounded-full flex items-center gap-2">
                    <span>${ing}</span>
                    <button onclick="removeIngredient(${index})" class="text-indigo-500 hover:text-indigo-800">&times;</button>
                </div>
            `).join('');
            updateIngredientButton();
        }

        window.addIngredient = () => {
            const ingredient = ingredientInput.value.trim();
            if (ingredient && !ingredients.includes(ingredient)) {
                ingredients.push(ingredient);
                renderIngredients();
            }
            ingredientInput.value = '';
            ingredientInput.focus();
        };

        window.removeIngredient = (index) => {
            ingredients.splice(index, 1);
            renderIngredients();
        };

        async function handleFindRecipes() {
            showView('results-view');
            resultsGrid.innerHTML = '';
            resultsError.classList.add('hidden');
            resultsLoader.classList.remove('hidden');

            const numPeople = document.getElementById('num-people').value;
            const numRecipes = document.getElementById('num-recipes').value;
            const calories = document.getElementById('calories').value;
            const protein = document.getElementById('protein').value;
            const selectedMealBtn = mealTypeSelector.querySelector('.bg-indigo-600');
            const mealType = selectedMealBtn ? selectedMealBtn.dataset.meal : 'Middag';

            const systemPrompt = `Du er en kreativ og hjelpsom kokk. Gi meg oppskrifter i JSON-format basert på schema. Alle felter må fylles ut. Ingredienslisten må være komplett for hele retten. Beskrivelsen skal være kort og fristende.`;
            let userPrompt = `Jeg har følgende ingredienser: ${ingredients.join(', ')}. Jeg vil lage ${mealType} for ${numPeople} person(er). Gi meg ${numRecipes} forslag.`;
            if (calories) userPrompt += ` Hver porsjon bør være rundt ${calories} kalorier.`;
            if (protein) userPrompt += ` Hver porsjon bør ha rundt ${protein} gram protein.`;

            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        title: { type: "STRING" },
                        description: { type: "STRING" },
                        time: { type: "STRING" },
                        servings: { type: "NUMBER" },
                        calories: { type: "NUMBER" },
                        ingredients: { type: "ARRAY", items: { type: "STRING" } },
                        method: { type: "ARRAY", items: { type: "STRING" } },
                    },
                    required: ["title", "description", "time", "servings", "calories", "ingredients", "method"]
                }
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate-recipes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userPrompt, systemPrompt, schema })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'En ukjent feil oppstod');
                }
                const data = await response.json();
                generatedRecipes = JSON.parse(data.text);
                renderResults();
            } catch (error) {
                console.error("Feil ved henting av oppskrifter:", error);
                resultsError.textContent = `Oops! Noe gikk galt: ${error.message}`;
                resultsError.classList.remove('hidden');
            } finally {
                resultsLoader.classList.add('hidden');
            }
        }
        
        async function generateImage(title, index) {
            const imgContainer = document.getElementById(`recipe-image-${index}`);
            if (!imgContainer) return null;
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate-image`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: title })
                });
                const data = await response.json();
                if (data.error) { throw new Error(data.error); }
                
                const imageUrl = `data:image/png;base64,${data.base64Image}`;
                imgContainer.innerHTML = `<img src="${imageUrl}" alt="${title}" class="w-full h-full object-cover">`;
                return data.base64Image;

            } catch (error) {
                console.error(`Feil ved generering av bilde for "${title}":`, error);
                const errorMessage = error.message.includes('enklere oppskrift') 
                    ? 'Bildet kunne ikke lages.<br>Prøv en annen oppskrift.' 
                    : 'Bildefeil.';
                imgContainer.innerHTML = `<div class="p-2 text-center text-red-600 bg-red-100 h-full flex items-center justify-center text-xs font-semibold">${errorMessage}</div>`;
                return null;
            }
        }

        function renderResults() {
            resultsGrid.innerHTML = generatedRecipes.map((recipe, index) => `
                <div onclick="selectRecipe(${index})" class="bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1">
                    <div id="recipe-image-${index}" class="h-48 bg-slate-200 flex items-center justify-center text-slate-500">
                         <div class="text-center">
                            <div class="w-8 h-8 border-4 border-slate-300 border-t-slate-500 rounded-full animate-spin mx-auto"></div>
                            <p class="text-sm mt-2">Lager bilde...</p>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg">${recipe.title}</h3>
                    </div>
                </div>
            `).join('');

            generatedRecipes.forEach((recipe, index) => {
                generateImage(recipe.title, index);
            });
        }
        
        window.selectRecipe = (index, fromSaved = false) => {
            selectedRecipe = fromSaved ? savedRecipes[index] : generatedRecipes[index];
            renderRecipeDetails();
            showView('details-view');
        };

        function renderRecipeDetails() {
            const isSaved = savedRecipes.some(r => r.title === selectedRecipe.title);
            let saveButtonHtml = '';
            if (isSaved) {
                saveButtonHtml = `
                <button class="bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 text-sm cursor-default">
                    <i class="ph-fill ph-check-circle"></i> Lagret
                </button>`;
            } else {
                saveButtonHtml = `
                 <button onclick="saveRecipe()" class="bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition flex items-center justify-center gap-2 text-sm">
                    <i class="ph-fill ph-heart"></i> Lagre Oppskrift
                </button>`;
            }

            detailsView.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <button onclick="goBack()" class="flex items-center gap-2 text-slate-600 hover:text-indigo-600 font-semibold">
                        <i class="ph ph-arrow-left"></i> Tilbake
                    </button>
                    ${saveButtonHtml}
                </div>
                <h2 class="text-4xl font-bold mb-2">${selectedRecipe.title}</h2>
                <p class="text-slate-500 mb-6">${selectedRecipe.description}</p>
                <div id="details-image-container" class="h-64 sm:h-80 md:h-96 bg-slate-200 rounded-lg mb-6 flex items-center justify-center overflow-hidden">
                     <div class="text-center text-slate-500">
                        <div class="w-8 h-8 border-4 border-slate-300 border-t-slate-500 rounded-full animate-spin mx-auto"></div>
                        <p class="text-sm mt-2">Lager bilde...</p>
                    </div>
                </div>
                <div class="flex justify-around text-center border-y py-4 mb-6">
                    <div><strong class="block text-xl">${selectedRecipe.time}</strong><span class="text-sm text-slate-500">Tid</span></div>
                    <div><strong class="block text-xl">${selectedRecipe.servings}</strong><span class="text-sm text-slate-500">Personer</span></div>
                    <div><strong class="block text-xl">${selectedRecipe.calories}</strong><span class="text-sm text-slate-500">Kalorier</span></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-2xl font-bold mb-4">Ingredienser</h3>
                        <ul class="list-disc list-inside space-y-2">
                            ${selectedRecipe.ingredients.map(ing => `<li>${ing}</li>`).join('')}
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold mb-4">Fremgangsmåte</h3>
                        <ol class="list-decimal list-inside space-y-3">
                             ${selectedRecipe.method.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                </div>
            `;
            
            const imageContainer = document.getElementById('details-image-container');
            
            // Vi lager en unik, midlertidig ID for bilde-elementet
            const tempId = `recipe-image-details-${Date.now()}`;
            let hiddenContainer = document.getElementById('details-image-hidden-container');
            if(!hiddenContainer) {
                hiddenContainer = document.createElement('div');
                hiddenContainer.id = 'details-image-hidden-container';
                hiddenContainer.style.display = 'none';
                document.body.appendChild(hiddenContainer);
            }
            hiddenContainer.innerHTML = `<div id="${tempId}"></div>`;

            generateImage(selectedRecipe.title, tempId).then(() => {
                const tempImage = document.getElementById(tempId);
                if (tempImage && tempImage.firstChild) {
                    imageContainer.innerHTML = '';
                    imageContainer.appendChild(tempImage.firstChild);
                } else {
                     imageContainer.innerHTML = `<div class="p-4 text-center text-red-600 bg-red-100 h-full flex items-center justify-center text-sm font-semibold">Kunne ikke laste bilde.</div>`;
                }
            });
        }
        
        window.goBack = () => {
             const fromSaved = document.referrer.includes('saved'); // Simple check, might need improvement
             if (views['saved-view'].dataset.cameFrom === 'details') {
                 showView('saved-view');
             } else {
                 showView('results-view');
             }
        };

        function loadSavedRecipes() {
            try {
                const recipesJSON = localStorage.getItem('savedRecipes');
                savedRecipes = recipesJSON ? JSON.parse(recipesJSON) : [];
                
                const hasSavedRecipes = savedRecipes.length > 0;
                savedRecipesLinkContainer.classList.toggle('hidden', !hasSavedRecipes);
                resultsSavedRecipesLinkContainer.classList.toggle('hidden', !hasSavedRecipes);
            } catch (error) {
                console.error("Feil ved lasting av lagrede oppskrifter:", error);
                localStorage.removeItem('savedRecipes');
                savedRecipes = [];
            }
        }
        
        function renderSavedRecipes() {
            loadSavedRecipes();
            if (savedRecipes.length === 0) {
                noSavedRecipes.classList.remove('hidden');
                savedGrid.classList.add('hidden');
            } else {
                noSavedRecipes.classList.add('hidden');
                savedGrid.classList.remove('hidden');
                savedGrid.innerHTML = savedRecipes.map((recipe, index) => `
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-4">
                            <h3 class="font-bold text-lg">${recipe.title}</h3>
                            <p class="text-sm text-slate-500 h-10 overflow-hidden">${recipe.description}</p>
                            <div class="mt-4 flex justify-between">
                                <button onclick="selectRecipe(${index}, true); views['saved-view'].dataset.cameFrom = 'details';" class="text-sm bg-indigo-100 text-indigo-700 font-semibold py-1 px-3 rounded-lg hover:bg-indigo-200">Se Oppskrift</button>
                                <button onclick="deleteRecipe(${index})" class="text-sm bg-red-100 text-red-700 font-semibold py-1 px-3 rounded-lg hover:bg-red-200">Slett</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        window.saveRecipe = () => {
            if (selectedRecipe && !savedRecipes.some(r => r.title === selectedRecipe.title)) {
                savedRecipes.push(selectedRecipe);
                localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
                renderRecipeDetails();
                loadSavedRecipes();
            }
        };

        window.deleteRecipe = (index) => {
            savedRecipes.splice(index, 1);
            localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
            renderSavedRecipes();
        };

        function setupMealTypeSelector() {
            const hour = new Date().getHours();
            let defaultMeal;
            if (hour >= 5 && hour < 11) defaultMeal = 'Frokost';
            else if (hour >= 11 && hour < 16) defaultMeal = 'Lunsj';
            else if (hour >= 16 && hour < 21) defaultMeal = 'Middag';
            else defaultMeal = 'Kveldsmat';

            mealTypeSelector.querySelectorAll('.meal-btn').forEach(btn => {
                if (btn.dataset.meal === defaultMeal) {
                    btn.classList.add('bg-indigo-600', 'text-white');
                    btn.classList.remove('border-slate-300', 'text-slate-700');
                } else {
                     btn.classList.remove('bg-indigo-600', 'text-white');
                     btn.classList.add('border-slate-300', 'text-slate-700');
                }
                btn.addEventListener('click', () => {
                    mealTypeSelector.querySelectorAll('.meal-btn').forEach(b => {
                        b.classList.remove('bg-indigo-600', 'text-white');
                        b.classList.add('border-slate-300', 'text-slate-700');
                    });
                    btn.classList.add('bg-indigo-600', 'text-white');
                    btn.classList.remove('border-slate-300', 'text-slate-700');
                });
            });
        }
        
        function toggleModal(modalId, forceOpen = null) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const isHidden = modal.classList.contains('hidden');
            if (forceOpen === true || isHidden) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else if (forceOpen === false || !isHidden) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function openAiHelpModal() {
            const detailsViewActive = !views.details.classList.contains('hidden');
            aiChatError.textContent = '';
            
            if (detailsViewActive && selectedRecipe) {
                aiModalTitle.textContent = `Spørsmål om: ${selectedRecipe.title}`;
                aiConversation = [
                    { role: "user", parts: [{ text: `Kontekst: Jeg ser på en oppskrift som heter "${selectedRecipe.title}". Ingrediensene er: ${selectedRecipe.ingredients.join(', ')}. Fremgangsmåten er: ${selectedRecipe.method.join(' ')}. Svar kort og hjelpsomt på mine neste spørsmål om denne oppskriften.` }] },
                    { role: "model", parts: [{ text: `Ok, jeg er klar til å hjelpe deg med oppskriften på ${selectedRecipe.title}! Hva lurer du på?` }] }
                ];
            } else {
                aiModalTitle.textContent = 'Spør Kjøleskaps-kokken';
                aiConversation = [
                    { role: "user", parts: [{ text: "Du er 'Kjøleskaps-kokken', en generell og hjelpsom AI-assistent for alt som har med mat og matlaging å gjøre. Svar på brukerens spørsmål." }] },
                    { role: "model", parts: [{ text: "Hei! Jeg er Kjøleskaps-kokken. Spør meg om hva som helst som har med mat å gjøre!" }] }
                ];
            }
            renderAiChat();
            toggleModal('ai-help-modal', true);
            setTimeout(() => aiQuestionInput.focus(), 100);
        }
        
        function renderAiChat() {
            aiChatBox.innerHTML = aiConversation.slice(2).map(msg => `
                <div class="chat-message ${msg.role === 'user' ? 'text-right' : ''}">
                    <div class="inline-block p-3 rounded-xl ${msg.role === 'user' ? 'bg-indigo-500 text-white' : 'bg-slate-200 text-slate-800'}">
                        ${msg.parts[0].text.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `).join('');
            aiChatBox.scrollTop = aiChatBox.scrollHeight;
        }

        async function handleAiChat() {
            const question = aiQuestionInput.value.trim();
            if (!question) return;

            aiQuestionInput.value = '';
            aiChatError.textContent = '';
            document.getElementById('ai-send-text').classList.add('hidden');
            document.getElementById('ai-send-spinner').classList.remove('hidden');
            aiSendBtn.disabled = true;

            aiConversation.push({ role: "user", parts: [{ text: question }] });
            renderAiChat();

            try {
                const response = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversation: aiConversation })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Ukjent feil fra server');
                }
                const data = await response.json();
                aiConversation.push({ role: "model", parts: [{ text: data.text }] });
                renderAiChat();
            } catch (error) {
                console.error("Feil i AI-chat:", error);
                aiChatError.textContent = `Beklager, noe gikk galt: ${error.message}`;
            } finally {
                document.getElementById('ai-send-text').classList.remove('hidden');
                document.getElementById('ai-send-spinner').classList.add('hidden');
                aiSendBtn.disabled = false;
                aiQuestionInput.focus();
            }
        }
        
        // ---------- EVENT LISTENERS ----------
        addIngredientBtn.addEventListener('click', addIngredient);
        ingredientInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addIngredient();
        });
        findRecipesBtn.addEventListener('click', handleFindRecipes);
        aiHelpFab.addEventListener('click', openAiHelpModal);
        aiSendBtn.addEventListener('click', handleAiChat);
        aiQuestionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAiChat();
        });

        // Initialisering
        updateIngredientButton();
        loadSavedRecipes();
        renderSavedRecipes();
        setupMealTypeSelector();
        showView('home-view');
        
        // Gjør funksjoner globale slik at inline onclick kan bruke dem
        window.showView = showView;
        window.renderSavedRecipes = renderSavedRecipes;
        window.toggleModal = toggleModal;
    });
</script>
</body>
</html>





